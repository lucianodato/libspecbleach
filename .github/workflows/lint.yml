name: lint

on:
  pull_request:
    branches:
      - "*"

jobs:
  format-check:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update -qq
          sudo apt-get install -qq clang-format

      - name: Check code formatting
        run: |
          find . -type f \( -name "*.c" -o -name "*.h" \) \
            ! -path "./build*" \
            ! -path "./.git/*" \
            | xargs clang-format --dry-run --Werror || {
            echo "Code formatting check failed. Please run: clang-format -i <file>"
            exit 1
          }

  static-analysis:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -qq \
            clang \
            clang-tidy \
            clang-tools \
            ninja-build \
            libfftw3-dev \
            libsndfile1-dev \
            meson

      - name: Configure build
        run: |
          meson setup build \
            --buildtype=debug \
            -Dwarning_level=3 \
            -Denable_examples=true

      - name: Run scan-build
        run: |
          scan-build --status-bugs \
            meson compile -C build

      - name: Run clang-tidy
        run: |
          # Use compile_commands.json from build directory
          find src include -type f \( -name "*.c" -o -name "*.h" \) | \
            xargs clang-tidy -p build --config-file=.clang-tidy

  cppcheck:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install cppcheck
        run: |
          sudo apt-get update -qq
          sudo apt-get install -qq cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --error-exitcode=1 \
            --inline-suppr \
            --quiet \
            src/ include/

