# libspecbleach Development Rules

This file contains consolidated development rules for libspecbleach that work with both Cursor and Antigravity IDEs.

## Code Formatting and Development Workflow

---
description: "Code formatting and development workflow guidelines for libspecbleach"
alwaysApply: true
---

**CRITICAL**: Always run `ninja -C build format` after modifying any C/C++ files (.c, .h, .cpp, .hpp).

### Why Formatting Matters
- CI/CD pipeline includes clang-format checks
- Pull requests fail if formatting is incorrect
- Consistent style improves maintainability
- Prevents style debates in code reviews

### When to Format
- After adding new code
- After modifying existing C/C++ files
- Before committing changes
- Before creating pull requests

### How to Format
```bash
# Format all C/C++ files in the project
ninja -C build format

# Or format individual files
clang-format -i path/to/file.c
```

## Build System Rules

**Use Meson for everything** - no Makefiles or separate scripts.

### Common Commands
```bash
# Configure build
meson setup build -Denable_examples=true

# Build project
meson compile -C build

# Run tests
meson test -C build

# Format code
ninja -C build format

# Clean and rebuild
rm -rf build && meson setup build -Denable_examples=true

# Force fallback to local subproject (when symlinked)
meson setup build --wrap-mode=forcefallback
```

## Code Style Guidelines

### C Code Standards
- LLVM clang-format style (defined in `.clang-format`)
- 2-space indentation, 80-character line limit
- Descriptive variable and function names
- Comprehensive error checking
- Clear documentation in header files
- **Mathematical Constants**: Always get `M_PI` from `src/shared/configurations.h` instead of defining it locally.

### Safety and Robustness
- **Initialization & Cleanup**: Always implement a matching pair of `_initialize` and `_free` functions.
- **NULL Checks**: Every `_free` function **MUST** start with `if (!self) return;`.
- **Atomic Initialization**: In `_initialize`, check every allocation. If any sub-allocation fails, call the module's `_free` function and return `NULL` to avoid memory leaks.
- **Allocation**: Use `calloc` for structure allocation to ensure it is zero-initialized.

### FFT Buffer Management
- **Format**: This library uses the FFTW Half-Complex (R2HC) format.
- **Sizing**: When processing spectral data that requires mirroring (e.g., gain estimation at indices up to `fft_size - 1`), always ensure buffers are sized to `fft_size`, not just `real_spectrum_size`. Using too small a buffer will cause stack-buffer-overflows.
- **Verification**: Always run the Clang Static Analyzer: `/opt/homebrew/opt/llvm/bin/scan-build meson compile -C build`.
### Public API Design
- Keep internal configurations, macros, and enums out of the public headers in `include/specbleach/`.
- Use primitive types (`int`, `float`, `bool`) in public parameter structures to maintain ABI compatibility and simplify the interface.
- Documentation for public parameters should clearly specify expected integer ranges and their meanings.
- Complex logic and internal types should remain in `src/`.

### File Organization
- Public APIs in `include/specbleach/`
- Implementation in `src/`
- Tests in `tests/`
- Examples in `examples/`

## Commit Workflow

1. Make changes to code
2. Run `ninja -C build format`
3. Test compilation: `meson compile -C build`
4. Run tests: `meson test -C build`
5. Commit with clear message

## Common Issues

### Build Failures
- Ensure FFTW and libsndfile dependencies are installed
- Check Meson configuration is correct
- Verify compiler supports required features
- **For subproject issues**: Use `--wrap-mode=forcefallback` to force local subproject usage

### Formatting Issues
- Run `ninja -C build format` to fix
- Ensure clang-format is installed
- Check `.clang-format` file exists and is correct

### Test Failures
- Reference files may need regeneration: `./tests/generate_reference_files.sh`
- Check for numerical precision issues
- Verify audio test files exist

## Quality Assurance

### Testing Requirements
- Unit tests must pass: `meson test -C build`
- Integration tests included in test suite
- Audio quality verified with examples
- No new compiler warnings

### Code Review Checklist
- [ ] Code is properly formatted (`ninja -C build format`)
- [ ] Tests pass
- [ ] Documentation updated for API changes
- [ ] No new compiler warnings
- [ ] Follows established code style

## Development Environment

### Required Tools
- C compiler (clang/gcc)
- Meson build system
- Ninja build tool
- clang-format
- FFTW library
- libsndfile library

### Recommended Tools
- clang-tidy (static analysis)
- Valgrind (memory checking)
- Audio analysis tools

## Project Structure

```
libspecbleach/
├── include/specbleach/     # Public API headers
├── src/                    # Implementation
│   ├── shared/            # Common utilities
│   └── processors/        # Audio processors
├── tests/                 # Test suite
├── examples/              # Usage examples
├── meson.build           # Build configuration
├── .clang-format         # Formatting rules
└── .gitignore           # Git ignore rules
```

## API Documentation

Public headers in `include/specbleach/` contain comprehensive documentation for all parameters and functions. This documentation is automatically available in IDE tooltips and should be kept up-to-date with API changes.

## Algorithm Implementation Notes

- **Wiener Filter**: Uses SNR/(SNR+1) formula for optimal noise reduction
- **Spectral Gating**: Applies soft thresholding with 60dB maximum attenuation
- **Masking Thresholds**: Psychoacoustic masking based on critical bands
- **Transient Protection**: Adaptive smoothing based on spectral flux detection
- **STFT Processing**: 50% overlap with configurable window functions
- **Noise Learning**: All 3 modes (Mean/Median/Max) learn simultaneously when `learn_noise > 0`
- **Profile Availability**: Different modes become available after different amounts of audio:
  - **Maximum**: Immediately available
  - **Median**: Requires buffer filling (typically quick)
  - **Rolling Mean**: Requires 5+ STFT frames (minimum learning time)

## Performance Considerations

- Real-time processing optimized for low latency
- SIMD acceleration through FFTW
- Memory-aligned allocations for optimal performance
- Efficient buffer management for continuous audio streams
